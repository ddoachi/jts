---
# ============================================================================
# SPEC METADATA - This entire frontmatter section contains the spec metadata
# ============================================================================

# === IDENTIFICATION ===
id: fed33392 # Unique identifier (never changes)
title: CI/CD Pipeline Foundation
type: feature

# === HIERARCHY ===
parent: 'E01'
children:
  - 'E01-F04-T01'
  - 'E01-F04-T02'
  - 'E01-F04-T03'
  - 'E01-F04-T04'
  - 'E01-F04-T05'
  - 'E01-F04-T06'
  - 'E01-F04-T07'
  - 'E01-F04-T08'
  - 'E01-F04-T09'
  - 'E01-F04-T10'
  - 'E01-F04-T11'
epic: E01
domain: infrastructure

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-08-24'
updated: '2025-08-24'
due_date: ''
estimated_hours: 21
actual_hours: 0

# === METADATA ===
tags:
  - cicd
  - github-actions
  - docker
  - automation
  - testing
  - deployment
  - security
effort: medium
risk: medium
---

# CI/CD Pipeline Foundation

## Overview

Establish a comprehensive CI/CD pipeline foundation using GitHub Actions for the JTS automated trading system. This feature implements automated build processes, comprehensive testing workflows, Docker containerization, security scanning, and deployment pipelines. The pipeline ensures code quality, security, and reliable deployments across development, staging, and production environments.

## Acceptance Criteria

- [ ] **GitHub Actions Workflows**: Complete CI/CD pipeline with matrix builds, parallel execution, and caching
- [ ] **Build Automation**: Automated builds for all services with Nx affected builds and Docker multi-stage builds
- [ ] **Test Automation**: Comprehensive testing including unit, integration, e2e tests with 95% coverage requirement
- [ ] **Security Scanning**: SAST, dependency scanning, container vulnerability scanning, and secrets detection
- [ ] **Docker Registry**: Automated Docker image building, tagging, and pushing to container registry
- [ ] **Deployment Pipeline**: Blue-green deployments with rollback capabilities and environment promotion
- [ ] **Quality Gates**: Code coverage thresholds, security gates, and performance benchmarks
- [ ] **Notifications**: Slack/Discord integration for build status, deployments, and failures
- [ ] **Branch Protection**: Protected main branch with required status checks and code review
- [ ] **Release Management**: Semantic versioning, automated changelog generation, and GitHub releases

## Technical Approach

### CI/CD Architecture

#### Pipeline Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                        GitHub Actions Pipeline                     │
└─────────────────────────────────────────────────────────────────────┘
                                   │
┌─────────────────┬─────────────────┼─────────────────┬───────────────┐
│   Code Quality  │     Security    │     Build       │   Deployment  │
│                 │                 │                 │               │
│  • Linting      │  • SAST Scan    │  • Nx Affected  │  • Dev Deploy │
│  • Format Check │  • Dependency   │  • Docker Build │  • Staging    │
│  • Type Check   │    Scan         │  • Registry     │  • Production │
│  • Unit Tests   │  • Secret Scan  │    Push         │  • Rollback   │
│  • E2E Tests    │  • Container    │  • Artifacts    │  • Monitoring │
│  • Coverage     │    Scan         │    Upload       │  • Alerts     │
└─────────────────┴─────────────────┴─────────────────┴───────────────┘
```

#### Workflow Structure

```
.github/workflows/
├── ci.yml                    # Main CI pipeline
├── security.yml              # Security scanning
├── deploy-dev.yml            # Development deployment
├── deploy-staging.yml        # Staging deployment
├── deploy-production.yml     # Production deployment
├── release.yml               # Release management
├── cleanup.yml               # Environment cleanup
├── performance.yml           # Performance testing
└── dependency-update.yml     # Automated dependency updates
```

### Core CI/CD Workflows

#### 1. Main CI Pipeline (`.github/workflows/ci.yml`)

```yaml
name: CI Pipeline

on:
  push:
    branches: [main, develop, 'feature/**', 'hotfix/**']
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
  NX_BRANCH: ${{ github.event.number || github.ref_name }}
  NX_CLOUD_DISTRIBUTED_EXECUTION: true
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  setup:
    name: Setup and Cache
    runs-on: ubuntu-latest
    outputs:
      has-affected: ${{ steps.affected.outputs.has-affected }}
      affected-apps: ${{ steps.affected.outputs.affected-apps }}
      affected-libs: ${{ steps.affected.outputs.affected-libs }}
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Generate Cache Key
        id: cache-key
        run: |
          echo "key=node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_OUTPUT

      - name: Cache Node Modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install Dependencies
        run: npm ci --prefer-offline

      - name: Cache Nx
        uses: actions/cache@v3
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-

      - name: Check Affected
        id: affected
        run: |
          AFFECTED_APPS=$(npx nx show projects --affected --type=app --base=origin/main~1 | tr '\n' ',' | sed 's/,$//')
          AFFECTED_LIBS=$(npx nx show projects --affected --type=lib --base=origin/main~1 | tr '\n' ',' | sed 's/,$//')
          HAS_AFFECTED=$([ -n "$AFFECTED_APPS" ] || [ -n "$AFFECTED_LIBS" ] && echo 'true' || echo 'false')

          echo "affected-apps=$AFFECTED_APPS" >> $GITHUB_OUTPUT
          echo "affected-libs=$AFFECTED_LIBS" >> $GITHUB_OUTPUT
          echo "has-affected=$HAS_AFFECTED" >> $GITHUB_OUTPUT

          echo "Affected Apps: $AFFECTED_APPS"
          echo "Affected Libs: $AFFECTED_LIBS"
          echo "Has Affected: $HAS_AFFECTED"

  code-quality:
    name: Code Quality
    needs: setup
    if: needs.setup.outputs.has-affected == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        check: [lint, type-check, format]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore Node Modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Restore Nx Cache
        uses: actions/cache@v3
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-

      - name: Run Lint
        if: matrix.check == 'lint'
        run: npx nx affected --target=lint --parallel=3 --base=origin/main~1

      - name: Run Type Check
        if: matrix.check == 'type-check'
        run: npx nx affected --target=type-check --parallel=3 --base=origin/main~1

      - name: Check Format
        if: matrix.check == 'format'
        run: npx prettier --check .

  test:
    name: Test
    needs: setup
    if: needs.setup.outputs.has-affected == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-type: [unit, integration, e2e]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: jts_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore Node Modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Restore Nx Cache
        uses: actions/cache@v3
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-

      - name: Run Unit Tests
        if: matrix.test-type == 'unit'
        run: npx nx affected --target=test --configuration=ci --parallel=3 --base=origin/main~1 --coverage

      - name: Run Integration Tests
        if: matrix.test-type == 'integration'
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/jts_test
          REDIS_URL: redis://localhost:6379
        run: npx nx affected --target=integration-test --parallel=2 --base=origin/main~1

      - name: Run E2E Tests
        if: matrix.test-type == 'e2e'
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/jts_test
          REDIS_URL: redis://localhost:6379
        run: npx nx affected --target=e2e --parallel=1 --base=origin/main~1

      - name: Upload Coverage Reports
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v3
        with:
          directory: ./coverage
          flags: ${{ matrix.test-type }}
          fail_ci_if_error: false

      - name: Coverage Quality Gate
        if: matrix.test-type == 'unit'
        run: |
          COVERAGE=$(grep -o '"pct":[0-9.]*' coverage/coverage-summary.json | head -1 | grep -o '[0-9.]*')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 95" | bc -l) )); then
            echo "❌ Coverage $COVERAGE% is below required 95%"
            exit 1
          else
            echo "✅ Coverage $COVERAGE% meets requirement"
          fi

  build:
    name: Build
    needs: [setup, code-quality, test]
    if: always() && needs.setup.outputs.has-affected == 'true' && needs.code-quality.result == 'success' && needs.test.result == 'success'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          [
            'api-gateway',
            'strategy-engine',
            'risk-management',
            'order-execution',
            'market-data-collector',
            'web-app',
          ]
    outputs:
      image-tags: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore Node Modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Restore Nx Cache
        uses: actions/cache@v3
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-

      - name: Build Service
        run: npx nx build ${{ matrix.service }} --configuration=production

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          platforms: linux/amd64,linux/arm64

  security-scan:
    name: Security Scan
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          [
            'api-gateway',
            'strategy-engine',
            'risk-management',
            'order-execution',
            'market-data-collector',
            'web-app',
          ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}.sarif'

  deployment-ready:
    name: Deployment Ready
    needs: [build, security-scan]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - name: Notify Deployment Ready
        run: |
          echo "🚀 All services built and scanned successfully"
          echo "✅ Ready for deployment to environments"
```

#### 2. Security Scanning Pipeline (`.github/workflows/security.yml`)

```yaml
name: Security Scanning

on:
  schedule:
    - cron: '0 2 * * 1' # Weekly on Monday at 2 AM
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  sast-scan:
    name: SAST Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: typescript, javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  dependency-scan:
    name: Dependency Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Dependencies
        run: npm ci

      - name: Audit Dependencies
        run: npm audit --audit-level moderate

      - name: OSCS Scan
        uses: actions/oscs/scan@v1
        with:
          token: ${{ secrets.OSCS_TOKEN }}
```

#### 3. Deployment Pipeline (`.github/workflows/deploy-production.yml`)

```yaml
name: Production Deployment

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: true
        default: 'latest'

concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  pre-deployment:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Health Check Production
        run: |
          curl -f https://api.jts.trading/health || echo "Service might be down"

  database-migration:
    name: Database Migration
    needs: pre-deployment
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.pre-deployment.outputs.version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Dependencies
        run: npm ci

      - name: Run Database Migrations
        env:
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
        run: npm run db:migrate

  blue-green-deployment:
    name: Blue-Green Deployment
    needs: [pre-deployment, database-migration]
    runs-on: ubuntu-latest
    environment: production
    strategy:
      matrix:
        service:
          [
            'api-gateway',
            'strategy-engine',
            'risk-management',
            'order-execution',
            'market-data-collector',
          ]
    steps:
      - name: Deploy to Green Environment
        run: |
          # Deploy new version to green environment
          kubectl set image deployment/${{ matrix.service }}-green \
            ${{ matrix.service }}=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:${{ needs.pre-deployment.outputs.version }} \
            --namespace=production-green

      - name: Wait for Rollout
        run: |
          kubectl rollout status deployment/${{ matrix.service }}-green --namespace=production-green --timeout=300s

      - name: Health Check Green Environment
        run: |
          # Perform health checks on green environment
          curl -f https://green.api.jts.trading/health

      - name: Switch Traffic to Green
        run: |
          # Switch traffic from blue to green
          kubectl patch service ${{ matrix.service }}-service \
            -p '{"spec":{"selector":{"version":"green"}}}' \
            --namespace=production

      - name: Monitor Deployment
        run: |
          sleep 30
          curl -f https://api.jts.trading/health

  post-deployment:
    name: Post-deployment
    needs: blue-green-deployment
    runs-on: ubuntu-latest
    steps:
      - name: Smoke Tests
        run: |
          # Run critical smoke tests
          curl -f https://api.jts.trading/api/v1/status
          curl -f https://api.jts.trading/api/v1/markets/health

      - name: Notify Success
        if: success()
        run: |
          echo "🎉 Production deployment successful!"
          # Send success notification to Slack/Discord

      - name: Rollback on Failure
        if: failure()
        run: |
          # Rollback to blue environment
          kubectl patch service api-gateway-service \
            -p '{"spec":{"selector":{"version":"blue"}}}' \
            --namespace=production
          echo "🔥 Deployment failed, rolled back to previous version"
```

### Docker Configuration

#### Multi-stage Dockerfile Template

```dockerfile
# apps/api-gateway/Dockerfile
ARG NODE_VERSION=20-alpine

# Build stage
FROM node:${NODE_VERSION} AS builder
WORKDIR /app

# Copy package files
COPY package*.json ./
COPY nx.json ./
COPY tsconfig.base.json ./

# Install dependencies
RUN npm ci --only=production && npm cache clean --force

# Copy source code
COPY apps/api-gateway ./apps/api-gateway
COPY libs ./libs

# Build the application
RUN npx nx build api-gateway --configuration=production

# Production stage
FROM node:${NODE_VERSION} AS production
WORKDIR /app

# Create non-root user
RUN addgroup -g F01 -S nodejs && \
    adduser -S nestjs -u F01

# Copy built application
COPY --from=builder --chown=nestjs:nodejs /app/dist/apps/api-gateway ./
COPY --from=builder --chown=nestjs:nodejs /app/node_modules ./node_modules

# Security: Remove unnecessary packages
RUN apk del --purge wget curl && \
    rm -rf /var/cache/apk/*

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node health-check.js

# Switch to non-root user
USER nestjs

EXPOSE E03

CMD ["node", "main.js"]
```

#### Docker Compose for CI

```yaml
# docker-compose.ci.yml
version: '3.8'

services:
  postgres-test:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: jts_test
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
    ports:
      - '5432:5432'
    tmpfs:
      - /var/lib/postgresql/data
    command: postgres -c fsync=off -c synchronous_commit=off -c full_page_writes=off

  redis-test:
    image: redis:7-alpine
    ports:
      - '6379:6379'
    tmpfs:
      - /data

  clickhouse-test:
    image: clickhouse/clickhouse-server:23.8-alpine
    environment:
      CLICKHOUSE_DB: jts_test_data
      CLICKHOUSE_USER: test_user
      CLICKHOUSE_PASSWORD: test_password
    ports:
      - '8123:8123'
      - 'E09:E09'
    tmpfs:
      - /var/lib/clickhouse

  mongodb-test:
    image: mongo:7.0-jammy
    environment:
      MONGO_INITDB_ROOT_USERNAME: test_user
      MONGO_INITDB_ROOT_PASSWORD: test_password
      MONGO_INITDB_DATABASE: jts_test_config
    ports:
      - '27017:27017'
    tmpfs:
      - /data/db

  kafka-test:
    image: confluentinc/cp-kafka:7.5.0
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-test:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    ports:
      - '9092:9092'
    depends_on:
      - zookeeper-test
    tmpfs:
      - /var/lib/kafka/data

  zookeeper-test:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: E02
    tmpfs:
      - /var/lib/zookeeper/data
      - /var/lib/zookeeper/log
```

### Quality Gates and Policies

#### Branch Protection Rules

```yaml
# .github/branch-protection-config.yml
protection_rules:
  main:
    required_status_checks:
      strict: true
      contexts:
        - 'CI Pipeline / Code Quality (lint)'
        - 'CI Pipeline / Code Quality (type-check)'
        - 'CI Pipeline / Code Quality (format)'
        - 'CI Pipeline / Test (unit)'
        - 'CI Pipeline / Test (integration)'
        - 'CI Pipeline / Test (e2e)'
        - 'CI Pipeline / Build'
        - 'CI Pipeline / Security Scan'
    enforce_admins: true
    required_pull_request_reviews:
      required_approving_review_count: 2
      dismiss_stale_reviews: true
      require_code_owner_reviews: true
    restrictions:
      users: []
      teams: ['core-developers']
```

#### Code Coverage Configuration

```javascript
// jest.config.coverage.js
module.exports = {
  collectCoverageFrom: [
    'apps/**/*.ts',
    'libs/**/*.ts',
    '!**/*.spec.ts',
    '!**/*.e2e-spec.ts',
    '!**/node_modules/**',
    '!**/dist/**',
    '!**/*.d.ts',
    '!**/main.ts',
  ],
  coverageThreshold: {
    global: {
      branches: 95,
      functions: 95,
      lines: 95,
      statements: 95,
    },
    './apps/': {
      branches: 95,
      functions: 95,
      lines: 95,
      statements: 95,
    },
    './libs/': {
      branches: 90,
      functions: 90,
      lines: 90,
      statements: 90,
    },
  },
  coverageReporters: ['text', 'text-summary', 'html', 'lcov', 'clover', 'json-summary'],
};
```

### Performance and Monitoring

#### Performance Testing Workflow

```yaml
# .github/workflows/performance.yml
name: Performance Testing

on:
  schedule:
    - cron: '0 1 * * *' # Daily at 1 AM
  workflow_dispatch:

jobs:
  api-performance:
    name: API Performance Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup k6
        run: |
          curl -s https://github.com/grafana/k6/releases/download/v0.46.0/k6-v0.46.0-linux-amd64.tar.gz | tar xz
          sudo mv k6-v0.46.0-linux-amd64/k6 /usr/local/bin/

      - name: Run Performance Tests
        run: |
          k6 run --out json=performance-results.json tools/performance/api-load-test.js

      - name: Upload Results
        uses: actions/upload-artifact@v3
        with:
          name: performance-results
          path: performance-results.json

  lighthouse-audit:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Dependencies
        run: npm ci

      - name: Build Frontend
        run: npx nx build web-app

      - name: Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun
```

### Release Management

#### Semantic Release Configuration

```json
{
  "branches": [
    "main",
    {
      "name": "develop",
      "prerelease": "beta"
    }
  ],
  "plugins": [
    "@semantic-release/commit-analyzer",
    "@semantic-release/release-notes-generator",
    [
      "@semantic-release/changelog",
      {
        "changelogFile": "CHANGELOG.md"
      }
    ],
    [
      "@semantic-release/npm",
      {
        "npmPublish": false
      }
    ],
    [
      "@semantic-release/github",
      {
        "assets": [
          {
            "path": "dist/**/*.tgz",
            "label": "Distribution Archive"
          }
        ]
      }
    ],
    [
      "@semantic-release/git",
      {
        "assets": ["CHANGELOG.md", "package.json", "package-lock.json"],
        "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
      }
    ]
  ]
}
```

## Task Dependencies and Parallel Execution Strategy

### Dependency Analysis

The 11 implementation tasks have been analyzed for dependencies to enable optimal parallel execution:

#### Dependency Matrix

| Task | Direct Dependencies | Can Run In Parallel With |
|------|-------------------|-------------------------|
| **T01: Workflow Structure** | None | T05, T06 |
| **T02: Main CI Pipeline** | T01, T05, T07 | T08 |
| **T03: Security Scanning** | T01 | T09, T10, T07 |
| **T04: Deployment Pipeline** | T01, T02, T05, T10 | T11 |
| **T05: Docker Multi-stage** | None | T01, T06 |
| **T06: Docker Compose CI** | None | T01, T05 |
| **T07: Test Automation** | T06 | T03, T09, T10 |
| **T08: Performance Testing** | T01, T07 | T02 |
| **T09: Release Management** | T01 | T03, T10, T07 |
| **T10: Branch Protection** | T01 | T03, T09, T07 |
| **T11: Monitoring** | T01, T02 | T04 |

### Parallel Execution Phases

```mermaid
gantt
    title CI/CD Pipeline Implementation Schedule
    dateFormat X
    axisFormat %H
    
    section Phase 1: Foundation (0-2h)
    T01 Workflow Structure     :t01, 0, 2
    T05 Docker Multi-stage     :t05, 0, 2
    T06 Docker Compose CI      :t06, 0, 2
    
    section Phase 2: Core (2-5h)
    T07 Test Automation        :t07, 2, 3
    T03 Security Scanning      :t03, 2, 2
    T09 Release Management     :t09, 2, 1
    T10 Branch Protection      :t10, 2, 1
    
    section Phase 3: Integration (5-8h)
    T02 Main CI Pipeline       :t02, 5, 3
    T08 Performance Testing    :t08, 5, 2
    
    section Phase 4: Deployment (8-11h)
    T04 Deployment Pipeline    :t04, 8, 3
    T11 Monitoring            :t11, 8, 2
```

### Critical Path

The critical path determines the minimum project duration:

```mermaid
graph LR
    T01[T01: Workflow<br/>2h] --> T07[T07: Test Config<br/>3h]
    T06[T06: Docker CI<br/>2h] --> T07
    T07 --> T02[T02: CI Pipeline<br/>3h]
    T02 --> T04[T04: Deployment<br/>3h]
    
    style T01 fill:#ff9999
    style T07 fill:#ff9999
    style T02 fill:#ff9999
    style T04 fill:#ff9999
```

**Critical Path**: T01/T06 → T07 → T02 → T04  
**Total Duration**: 11 hours (vs 21 hours sequential)  
**Time Savings**: 10 hours (47% reduction)

### Execution Strategy by Phase

#### Phase 1: Foundation (Hours 0-2) - 3 Parallel Tasks
- **T01**: Essential workflow structure (no dependencies)
- **T05**: Docker configurations (independent)
- **T06**: CI testing environment (independent)

#### Phase 2: Core Components (Hours 2-5) - 4 Parallel Tasks
- **T07**: Test automation (depends on T06)
- **T03**: Security scanning (depends on T01)
- **T09**: Release management (depends on T01)
- **T10**: Branch protection (depends on T01)

#### Phase 3: Integration (Hours 5-8) - 2 Parallel Tasks
- **T02**: Main CI pipeline (depends on T01, T05, T07)
- **T08**: Performance testing (depends on T01, T07)

#### Phase 4: Deployment & Monitoring (Hours 8-11) - 2 Parallel Tasks
- **T04**: Deployment pipeline (depends on T01, T02, T05, T10)
- **T11**: Monitoring setup (depends on T01, T02)

### Resource Allocation Recommendations

| Phase | Developers Needed | Key Skills Required |
|-------|------------------|-------------------|
| Phase 1 | 3 | GitHub Actions, Docker, Testing Infrastructure |
| Phase 2 | 2-3 | Security, Testing, DevOps |
| Phase 3 | 2 | CI/CD Integration, Performance Testing |
| Phase 4 | 2 | Deployment, Monitoring, Production Operations |

## Implementation Tasks

The feature has been broken down into the following implementation tasks:

### 1. [Task T01: GitHub Actions Workflow Structure Setup](T01/E01-F04-T01.spec.md)

**Estimated: 2 hours**

- Set up workflow directory structure and templates
- Configure reusable workflows and composite actions
- Establish caching strategy and environment configuration

### 2. [Task T02: Main CI Pipeline Configuration](T02/E01-F04-T02.spec.md)

**Estimated: 3 hours**

- Implement comprehensive CI workflow with Nx affected detection
- Configure parallel execution for quality checks and tests
- Set up coverage gates and build validation

### 3. [Task T03: Security Scanning Workflows](T03/E01-F04-T03.spec.md)

**Estimated: 2 hours**

- Configure SAST with CodeQL analysis
- Implement dependency and secret scanning
- Set up container vulnerability scanning with Trivy

### 4. [Task T04: Deployment Pipeline Workflows](T04/E01-F04-T04.spec.md)

**Estimated: 3 hours**

- Create environment-specific deployment workflows
- Implement blue-green deployment strategy
- Configure rollback mechanisms and health checks

### 5. [Task T05: Docker Multi-stage Build Configuration](T05/E01-F04-T05.spec.md)

**Estimated: 2 hours**

- Create optimized multi-stage Dockerfiles
- Implement security hardening and non-root users
- Optimize layer caching and image sizes

### 6. [Task T06: Docker Compose CI Testing Environment](T06/E01-F04-T06.spec.md)

**Estimated: 2 hours**

- Configure Docker Compose for CI testing
- Set up test databases and message queues
- Optimize for fast startup and teardown

### 7. [Task T07: Test Automation and Coverage Configuration](T07/E01-F04-T07.spec.md)

**Estimated: 3 hours**

- Configure Jest for unit, integration, and E2E tests
- Implement 95% coverage requirements
- Set up test reports and parallel execution

### 8. [Task T08: Performance Testing Workflow](T08/E01-F04-T08.spec.md)

**Estimated: 2 hours**

- Implement k6 for API load testing
- Configure Lighthouse for frontend audits
- Set up performance budgets and alerts

### 9. [Task T09: Release Management and Semantic Versioning](T09/E01-F04-T09.spec.md)

**Estimated: 1 hour**

- Configure semantic-release for versioning
- Set up automated changelog generation
- Implement GitHub release creation

### 10. [Task T10: Branch Protection and Quality Gates](T10/E01-F04-T10.spec.md)

**Estimated: 1 hour**

- Configure branch protection rules
- Set up required status checks and reviews
- Implement CODEOWNERS for automatic assignments

### 11. [Task T11: CI/CD Monitoring and Notifications](T11/E01-F04-T11.spec.md)

**Estimated: 2 hours**

- Integrate Slack/Discord notifications
- Configure build status reporting
- Set up PR comment integration

**Total Estimated Time: 21 hours**

## Dependencies

- **F03**: Monorepo Structure and Tooling - Required for Nx workspace and build configuration
- **F02**: Development Environment Setup - Related for local development and tooling

## Testing Plan

- Validate all CI/CD workflows execute successfully
- Test build automation with affected builds and caching
- Verify comprehensive test coverage and quality gates
- Test security scanning and vulnerability detection
- Validate deployment pipeline with blue-green strategy
- Test rollback mechanisms and monitoring
- Verify release management and semantic versioning

## Quality Gates

### Build Quality Gates

- All linting and formatting checks must pass
- TypeScript compilation must succeed without errors
- Unit test coverage must be ≥95%
- Integration test coverage must be ≥90%
- No high-severity security vulnerabilities
- Performance benchmarks must meet thresholds

### Deployment Quality Gates

- All quality gates must pass
- Security scans must show no critical vulnerabilities
- Health checks must pass in target environment
- Database migrations must complete successfully
- Smoke tests must pass post-deployment

## Configuration Files Summary

Key files created by this feature:

- `.github/workflows/ci.yml` - Main CI pipeline
- `.github/workflows/security.yml` - Security scanning
- `.github/workflows/deploy-*.yml` - Deployment pipelines
- `.github/workflows/performance.yml` - Performance testing
- `Dockerfile` templates for all services
- `docker-compose.ci.yml` - CI environment
- `.release.json` - Semantic release configuration
- Quality gate configurations

## Notes

- Optimize for fast feedback with parallel execution and caching
- Implement comprehensive security scanning at multiple stages
- Use blue-green deployments to minimize downtime
- Maintain high test coverage requirements for trading system reliability
- Consider implementing canary deployments for production releases
- Monitor pipeline performance and optimize bottlenecks regularly

## Status Updates

- **2025-08-24**: Feature specification created and documented
